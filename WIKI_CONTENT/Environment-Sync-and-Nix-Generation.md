# Environment Synchronization and Nix Generation

## Overview

We have implemented a robust strategy for maintaining the Nix environment that ensures consistency between the `DESCRIPTION` file and the `default.nix` file. This strategy also addresses the `$HOME` artifact bug.

## The `maintain_env.R` Script

Located at `R/setup/maintain_env.R`, this script is the single source of truth for generating:
1.  `default.nix` (Development environment)
2.  `package.nix` (Cachix/CI build derivation)
3.  `packages.R` (Helper for default.R)

### Key Features

1.  **Dependency Extraction**: Automatically parses `DESCRIPTION` to extract `Imports` and `Suggests` packages.
2.  **Robust Shell Hook**: Implements a `shell_hook` that correctly escapes variables to prevent the creation of literal `$HOME` folders (Issue #9).
3.  **Pinned Nixpkgs**: Uses a specific pinned version of `rstats-on-nix` for reproducibility.

### Implementation

```r
# R/setup/maintain_env.R

maintain_env <- function() {
  if (!requireNamespace("rix", quietly = TRUE)) {
    stop("rix package is not installed.")
  }
  library(rix)

  # 1. Read DESCRIPTION
  desc <- read.dcf("DESCRIPTION")
  
  get_packages <- function(field) {
    if (!(field %in% colnames(desc))) return(character(0))
    pkgs_str <- desc[1, field]
    if (is.na(pkgs_str)) return(character(0))
    pkgs <- strsplit(pkgs_str, ",")[[1]]
    pkgs <- trimws(pkgs)
    pkgs <- gsub("\s*\([^)]*\)", "", pkgs)
    pkgs <- pkgs[pkgs != "R"]
    return(pkgs)
  }

  imports <- get_packages("Imports")
  suggests <- get_packages("Suggests")
  
  # Base dev tools that we always want in the shell
  dev_tools <- c("devtools", "usethis", "gert", "gh", "rix", "testthat", "roxygen2", "rcmdcheck")
  
  # Combine and dedup
  r_pkgs <- unique(c(imports, suggests, dev_tools))
  r_pkgs <- sort(r_pkgs)
  
  # 2. Write packages.R
  packages_r_content <- paste0(
    "# This file is automatically generated by R/setup/maintain_env.R\n",
    "# Do not edit this file directly.\n\n",
    "r_pkgs <- c(\\n  \"", paste(r_pkgs, collapse = "\",\n  \""), "\"
)")
  writeLines(packages_r_content, "packages.R")
  message("Generated packages.R")

  # 3. Generate default.nix
  shell_hook <- r"---
mkdir -p $HOME/.config/positron
mkdir -p $HOME/.R/library
echo "R_LIBS_USER=$HOME/.R/library" >> $HOME/.Renviron

export R_MAKEVARS_USER=/dev/null
unset CI
printf "Environment loaded.\n"
)---"

  # System packages needed
  sys_pkgs <- c(
    "awscli2", "bc", "btop", "cacert", "clang", "curlMinimal", "direnv", "duckdb", 
    "gcc", "gh", "git", "glibcLocales", "gnupg", "htop", "jq", "less", 
    "nix", "nodejs", "pandoc", "quarto", "R", "tree", "which"
  )

  rix(
    r_ver = "4.4.2", 
    r_pkgs = r_pkgs,
    system_pkgs = sys_pkgs,
    git_pkgs = NULL, 
    ide = "none",
    project_path = ".",
    overwrite = TRUE,
    shell_hook = shell_hook
  )
  
  message("Generated default.nix")

  # 4. Generate package.nix
  pkg_name <- desc[1, "Package"]
  
  nix_list <- function(pkgs) {
    if (length(pkgs) == 0) return("")
    paste(pkgs, collapse = "\n    ")
  }
  
  package_nix_content <- sprintf(
'{ pkgs ? import (fetchTarball "https://github.com/rstats-on-nix/nixpkgs/archive/2025-02-24.tar.gz") {} }:

pkgs.rPackages.buildRPackage {
  name = "%s";
  src = ./.;

  propagatedBuildInputs = with pkgs.rPackages; [
    %s
  ];

  nativeBuildInputs = with pkgs.rPackages; [
    %s
  ];
}
', 
    pkg_name, 
    nix_list(imports),
    nix_list(suggests)
  )
  
  writeLines(package_nix_content, "package.nix")
  message("Generated package.nix")
}

if (!interactive()) {
  maintain_env()
}
```

## Integration

### `default.R`

The `default.R` file is simplified to just source the maintenance script:

```r
source("R/setup/maintain_env.R")
```

### Targets

The `_targets.R` file should track the relevant files to ensure the environment is updated when dependencies change:

```r
tar_target(description_file, "DESCRIPTION", format = "file"),
tar_target(maintain_script, "R/setup/maintain_env.R", format = "file"),

tar_target(
  nix_env_update,
  {
    description_file
    maintain_script
    source("R/setup/maintain_env.R")
    maintain_env()
    c("default.nix", "packages.R")
  },
  format = "file"
),
```
